@{
    ViewBag.Title = "Index";
}

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width" />

<div class="container-fluid">
    <div class="row-fluid">
        @* Products table *@
        <table id="productsTable" class="table table-bordered table-striped dsply-data" data-bind="foreach: products">
            <tr>
                @* Edit row icon *@
                <td data-bind="visible: isReadOnly" style="width: 25px;">
                    <i class="icon-pencil" data-bind="click: function () { toggleReadOnly(); isReadOnly(false); $parent.setIsChangedForAllProducts(false); }" title="Edit"></i>
                </td>

                @* Save row icon *@
                <td data-bind="visible: !isReadOnly()" style="width: 25px;">
                    <i class="icon-ok-sign" data-bind="click: function () { $parent.editProduct(this); isReadOnly(true); }" title="Save"></i>
                </td>

                @* Product Id *@
                <td data-bind="text: id, css: { 'isChanged': isChanged, 'isNotChanged': !isChanged() }" style="width: 7%;"></td>

                @* Product Name *@
                <td data-bind="visible: isReadOnly, text: name, click: toggleReadOnly, css: { 'isChanged': isChanged, 'isNotChanged': !isChanged() }" style="width: 44%;"></td>
                <td data-bind="visible: !isReadOnly()" style="width: 44%;">
                    <input data-bind="value: name" /></td>

                @* Product Category Name *@
                <td data-bind="visible: isReadOnly, text: category, click: toggleReadOnly, css: { 'isChanged': isChanged, 'isNotChanged': !isChanged() }" style="width: 44%;"></td>
                <td data-bind="visible: !isReadOnly()" style="width: 44%;">
                    <input data-bind="value: category" /></td>
            </tr>
        </table>
    </div>
</div>

@* For debugging:
    <br />
    <pre data-bind="text: ko.toJSON($data)"></pre> *@

<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>

<script type="text/javascript">
    $(function () {
        var productViewModel = new ProductViewModel($);

        // Populate table with content
        productViewModel.getProducts();

        // Reference the auto-generated proxy for the hub.  
        var hub = $.connection.messageHub;

        hub.client.resetProductTable = function () {
            productViewModel.setIsChangedForAllProducts(false);
        };

        // hub calls function to update productViewModel's products
        hub.client.updateProductDetails = function (product) {
            // set product to IsChanged
            var changed = productViewModel.getProduct(product["ProductId"]);
            changed.isChanged(true);

            // After an update has occurred, re-get products to display in table for all clients
            productViewModel.getProducts();
        };

        // Start the SignalR connection.
        $.connection.hub.start().done(function () {
        });
    });

    // This optional function html-encodes messages for display in the page.
    function htmlEncode(value) {
        var encodedValue = $('<div />').text(value).html();
        return encodedValue;
    }
</script>



